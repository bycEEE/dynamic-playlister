<div id="player"></div>
<script src="http://www.youtube.com/iframe_api"></script>

<!-- Player won't play starting with empty array
Player won't play after song is added when playlist is finished -->
<script>
    /*
     * Put your video IDs in this array
     */
    var videoIDs = [
        'i_kF4zLNKio', <%= @songs.html_safe %>
    ];

    var player, currentVideoId = 0;

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '350',
            width: '425',
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        event.target.loadVideoById(videoIDs[currentVideoId]);
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.ENDED) {
            currentVideoId++;
            if (currentVideoId < videoIDs.length) {
                player.loadVideoById(videoIDs[currentVideoId]);
            }
        }
    }
</script>

<%= form_tag do %>
  <%= submit_tag("skip", :id => "skip-song") %>
<% end %>
  

<div id="playlist" class="container col-xs-9 col-md-6 col-xs-offset-2 col-md-offset-2">
  <h1><%= @playlist.name %></h1>
  <table if="playlist-table">
    <% @playlist.requests.each do |request| %>
    <tr>
      <div>
        <div class="voting" id="voting-<%= request.id%>">
          <h6 id="vote-count-<%= request.id%>"><%= request.votes %></h6>
          <a class="upvote" id="upvote-<%= request.id%>"> upvote </a>
          <a class="downvote" id="downvote-<%= request.id%>">downvote</a>
        </div>
        <%= link_to "#{request.song.name}", request.song  %>
      </div>
    </tr>
    <% end %>
  </table>


  <h2>What we want:</h2>
  <%= render 'add_song_form' %>
</div>

<!-- CHAT FEATURE: -->
<%= render 'chat_box_and_form' %>

<!-- JS -->
<script>
	$(function() {
		$(":submit").click(function(event) {
      // debugger
      if ($(this).attr('id') == "intelligent-add-song") {
        event.preventDefault();
        $.post(location.href + "/songs", $("form").serialize(), function(data) {
          videoIDs.push(data.uid)  
        })

      } else if ($(this).attr('id') == "chat_send") {
        event.preventDefault();
  			// $.post("/playlist//chat_messages", $("form").serialize(), function(data) {	
  			$.post(location.href + "/chat_messages", $("form").serialize(), function(data) {	
  			})
  			$("#new_chat_message")[0].reset();
      }

		});

    $(".upvote").click(function(event) {
      var requestId = $(this).attr("id")
      requestId = requestId.replace("upvote-", "")
      $.post("/requests/upvote", {"request_id": requestId}, function(data) {  
        });
    });

    $(".downvote").click(function(event) {
      var requestId = $(this).attr("id")
      requestId = requestId.replace("downvote-", "")
      $.post("/requests/downvote", {"request_id": requestId}, function(data) {  
        });
    });
	});
</script>













